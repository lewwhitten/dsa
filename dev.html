<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Classroom Quiz Show</title>
<style>
  :root{
    --bg:#0f1226; --panel:#161a34; --accent:#4f8cff; --accent-2:#29d17c;
    --text:#f2f4ff; --muted:#9aa3c7; --tile:#1a1f41; --tile-hover:#212752;
    --warn:#ffb020; --danger:#ff5b5b; --ok:#29d17c; --shadow:0 8px 24px rgba(0,0,0,.3);
    --radius:14px; --radius-sm:10px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background:radial-gradient(1200px 600px at 10% -10%, #1c2050 0%, #0f1226 45%) no-repeat, var(--bg);
    color:var(--text);
    display:flex; flex-direction:column; gap:14px;
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px 0 16px;
  }
  header h1{margin:0; font-size:20px; letter-spacing:.4px}
  .btn{
    appearance:none; border:none; padding:10px 14px; border-radius:10px;
    background:var(--accent); color:white; font-weight:600; cursor:pointer;
    box-shadow:var(--shadow); transition:transform .04s ease, opacity .2s ease, filter .2s ease;
  }
  .btn.secondary{background:#2c3368}
  .btn.ghost{background:transparent; border:1px solid #3a4182; box-shadow:none}
  .btn.warn{background:var(--warn); color:#121212}
  .btn.danger{background:var(--danger)}
  .btn.ok{background:var(--ok); color:#102115}
  .btn:active{transform:translateY(1px)}
  .bar{display:flex; gap:8px; flex-wrap:wrap}
  main{display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:0 16px 16px 16px}
  @media (max-width: 980px){ main{grid-template-columns:1fr} }

  /* Panels */
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.04), transparent 90%), var(--panel);
    border:1px solid #2a3066; border-radius:var(--radius); box-shadow:var(--shadow);
    padding:14px; overflow:hidden;
  }
  .panel h2{margin:4px 0 10px 0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .stack{display:flex; flex-direction:column; gap:10px}
  .muted{color:var(--muted)}
  input[type="text"], input[type="number"], textarea, select{
    width:100%; padding:10px 12px; background:#0e1130; color:var(--text); border:1px solid #2a3066;
    border-radius:10px; outline:none;
  }
  textarea{min-height:90px; resize:vertical}
  label{font-size:12px; color:var(--muted)}

  /* Board */
  .board{
    background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 80%), #0e1333;
    border:1px solid #2a3066; border-radius:var(--radius); box-shadow:var(--shadow);
    padding:14px; display:flex; flex-direction:column; gap:12px;
  }
  .categories{display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px}
  .cat{
    display:flex; align-items:center; justify-content:center; text-align:center;
    padding:10px; background:#12174a; border:1px solid #2f3575; border-radius:12px; font-weight:700;
    min-height:56px;
  }
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px}
  .tile{
    background:var(--tile); border:1px solid #2a3066; border-radius:12px;
    display:flex; align-items:center; justify-content:center; min-height:86px; font-size:28px; font-weight:800;
    cursor:pointer; transition:background .2s ease, transform .05s ease; user-select:none;
  }
  .tile:hover{background:var(--tile-hover)}
  .tile.used{opacity:.25; text-decoration:line-through; pointer-events:none}
  .tile.locked{filter:saturate(.2) blur(.3px); position:relative}
  .tile.locked::after{content:"🔒"; position:absolute; top:8px; right:10px; font-size:16px; opacity:.8}

  /* Question Modal */
  .modal{
    position:fixed; inset:0; background:rgba(2,4,18,.52);
    display:none; align-items:center; justify-content:center; padding:16px; z-index:50;
  }
  .modal.open{display:flex}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.04), transparent 90%), #10153b;
    border:1px solid #2b3170; border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5);
    width:min(100%, 920px); max-height:90vh; display:flex; flex-direction:column;
  }
  .card-header{display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid #2a3066}
  .card-body{padding:16px; overflow:auto}
  .q{font-size:26px; line-height:1.35}
  .a{margin-top:12px; padding:12px; border-radius:12px; background:#0d1130; border:1px dashed #37408e; display:none}
  .a.show{display:block}
  .footer{display:flex; gap:8px; padding:12px 16px; border-top:1px solid #2a3066; flex-wrap:wrap}
  .pill{padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #2a3066; color:var(--muted)}

  /* Teams & buzzer */
  .teams{display:flex; flex-direction:column; gap:10px}
  .team{
    display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center; background:#10153b; border:1px solid #2a3066; border-radius:12px; padding:8px;
  }
  .team .name{font-weight:700}
  .score{font-variant-numeric:tabular-nums; background:#0d1130; border:1px solid #2a3066; border-radius:10px; padding:6px 10px; min-width:64px; text-align:center}
  .buzzer-bar{display:grid; grid-template-columns:repeat(2,1fr); gap:8px}
  @media (min-width:680px){ .buzzer-bar{grid-template-columns:repeat(4,1fr)} }
  .buzzer{
    background:#1c2254; border:2px solid #2f3a99; border-radius:14px; padding:18px 10px; text-align:center; font-weight:800; cursor:pointer;
    box-shadow:var(--shadow);
  }
  .buzzer.active{background:#2843a8}
  .buzz-indicator{
    background:#09102f; border:1px solid #2a3066; padding:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; gap:10px;
  }
  .blink{animation:blink .8s infinite}
  @keyframes blink{50%{opacity:.35}}

  .mini{font-size:12px; color:var(--muted)}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0b0e24; border:1px solid #2a3066; border-radius:6px; padding:2px 6px; color:#cfe0ff}
  .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

  /* Timer */
  .timer{
    display:flex; align-items:center; gap:10px; background:#10153b; border:1px solid #2a3066; border-radius:12px; padding:10px;
  }
  .time{font-size:22px; font-weight:800; letter-spacing:.5px; min-width:64px; text-align:center}

  /* Collapsible */
  details{background:#10153b; border:1px solid #2a3066; border-radius:12px; padding:10px}
  summary{cursor:pointer; color:var(--muted); font-weight:700}

  .right-tools{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1>🎤 Quiz Show</h1>
  <div class="bar">
    <button class="btn" id="toggleControls">Hide Controls</button>
    <button class="btn ghost" id="fullscreenBtn">Fullscreen Board</button>
  </div>
</header>

<main>
  <!-- Left: Controls -->
  <section class="panel" id="controls">
    <h2>Host Controls</h2>
    <div class="stack">

      <div class="timer">
        <div class="time" id="time">00:30</div>
        <div class="bar">
          <button class="btn secondary" id="startTimer">Start</button>
          <button class="btn ghost" id="pauseTimer">Pause</button>
          <button class="btn ghost" id="resetTimer">Reset</button>
          <input type="number" id="timerSet" min="3" max="120" value="30" style="width:86px" />
        </div>
      </div>

      <div class="stack">
        <div class="row">
          <div class="bar">
            <button class="btn ok" id="revealAnswer">Reveal Answer</button>
            <button class="btn ghost" id="hideAnswer">Hide Answer</button>
            <button class="btn warn" id="lockTile">Lock Question</button>
            <button class="btn danger" id="closeQuestion">Close Question</button>
          </div>
        </div>
        <div class="row right-tools">
          <button class="btn secondary" id="exportBtn">Export Questions</button>
          <label class="btn ghost" for="importFile">Import <input id="importFile" type="file" accept=".json" hidden/></label>
          <button class="btn ghost" id="clearProgress">Clear Scores/Progress</button>
        </div>
      </div>

      <details>
        <summary>Question Editor (quick edit current)</summary>
        <div class="stack" style="margin-top:10px">
          <label>Category <input id="editCategory" type="text"></label>
          <label>Points <input id="editPoints" type="number" min="0" step="50"></label>
          <label>Question <textarea id="editQuestion"></textarea></label>
          <label>Answer <textarea id="editAnswer"></textarea></label>
          <div class="bar">
            <button class="btn ok" id="saveEdit">Save</button>
            <button class="btn ghost" id="cancelEdit">Cancel</button>
          </div>
          <p class="mini">Edits apply to the currently open tile.</p>
        </div>
      </details>

      <div class="stack">
        <h2>Teams & Scores</h2>
        <div id="teams" class="teams"></div>
        <div class="bar">
          <button class="btn" id="addTeam">Add Team</button>
          <button class="btn ghost" id="resetScores">Reset Scores</button>
        </div>
      </div>

      <div class="stack">
        <h2>Buzzers</h2>
        <div class="buzz-indicator">
          <div>First buzz: <strong id="firstBuzz">—</strong></div>
          <div class="bar"><button class="btn ghost" id="resetBuzzers">Reset Buzzers</button></div>
        </div>
        <div id="buzzerBar" class="buzzer-bar"></div>
        <div class="mini">Default keyboard keys: Team 1=<span class="kbd">A</span>, Team 2=<span class="kbd">S</span>, Team 3=<span class="kbd">K</span>, Team 4=<span class="kbd">L</span>. (Click a key label to change.)</div>
      </div>

    </div>
  </section>

  <!-- Right: Board -->
  <section class="board" id="board">
    <div class="categories" id="categoryRow"></div>
    <div class="grid" id="grid"></div>
  </section>
</main>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="card">
    <div class="card-header">
      <div>
        <div class="pill" id="modalMeta">—</div>
      </div>
      <div class="bar">
        <button class="btn ghost" id="modalReveal">Show Answer</button>
        <button class="btn ok" id="modalAward">Award to…</button>
        <button class="btn danger" id="modalClose">Close</button>
      </div>
    </div>
    <div class="card-body">
      <div class="q" id="modalQuestion">Question text…</div>
      <div class="a" id="modalAnswer">Answer text…</div>
    </div>
    <div class="footer">
      <div class="pill">⏱ <span id="modalTime">00:30</span></div>
      <div class="pill">Buzz: <span id="modalBuzz">—</span></div>
    </div>
  </div>
</div>

<script>
/* ====================== Data & Persistence ====================== */
const DEFAULT_SET = {
  gameTitle: "Algebra & ELA Review",
  categories: [
    { name: "Linear Functions", tiles: [
      { points:100, q:"Slope-intercept form looks like…", a:"y = mx + b" },
      { points:200, q:"Slope of a horizontal line?", a:"0" },
      { points:300, q:"Find slope: (2,4) to (5,10)", a:"(10-4)/(5-2) = 6/3 = 2" },
      { points:400, q:"m if y=3x+7", a:"3" },
      { points:500, q:"b if y=-2x+5", a:"5" }
    ]},
    { name: "Fractions", tiles: [
      { points:100, q:"1/2 + 1/2", a:"1" },
      { points:200, q:"4/5 − 1/5", a:"3/5" },
      { points:300, q:"2/3 + 1/6", a:"5/6" },
      { points:400, q:"3/4 − 5/8", a:"1/8" },
      { points:500, q:"Simplify 18/24", a:"3/4" }
    ]},
    { name: "Vocabulary", tiles: [
      { points:100, q:"Define ‘theme’.", a:"The central message or underlying idea." },
      { points:200, q:"‘Simile’ uses which words?", a:"like or as" },
      { points:300, q:"Antonym of ‘scarce’.", a:"abundant" },
      { points:400, q:"‘Infer’ means…", a:"Draw a conclusion from evidence & reasoning." },
      { points:500, q:"‘Alliteration’ is…", a:"Repeating initial consonant sounds." }
    ]},
    { name: "Percent & Decimals", tiles: [
      { points:100, q:"25% as a decimal", a:"0.25" },
      { points:200, q:"0.6 as a percent", a:"60%" },
      { points:300, q:"10% of 240", a:"24" },
      { points:400, q:"Increase 50 by 20%", a:"60" },
      { points:500, q:"What is 30% of 90?", a:"27" }
    ]},
    { name: "Grab Bag", tiles: [
      { points:100, q:"Prime after 13", a:"17" },
      { points:200, q:"3² + 4² = ?", a:"25" },
      { points:300, q:"Opposite of ‘transparent’", a:"opaque" },
      { points:400, q:"Area of 6×7 rectangle", a:"42" },
      { points:500, q:"Synonym of ‘evaluate’", a:"assess" }
    ]}
  ]
};

const STORE_KEYS = {
  set: "quizset.v1",
  progress: "quizprogress.v1",
  teams: "quizteams.v1",
  buzzer: "quizbuzzer.v1"
};

function loadJSON(key, fallback){
  try{
    const s = localStorage.getItem(key);
    if(!s) return structuredClone(fallback);
    return JSON.parse(s);
  }catch(e){ return structuredClone(fallback); }
}
function saveJSON(key, obj){
  try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){}
}

/* ====================== State ====================== */
let gameSet = loadJSON(STORE_KEYS.set, DEFAULT_SET);
let progress = loadJSON(STORE_KEYS.progress, { used: {}, locked:{} });
let teams = loadJSON(STORE_KEYS.teams, [
  { id: crypto.randomUUID(), name:"Team 1", score:0, key:"a" },
  { id: crypto.randomUUID(), name:"Team 2", score:0, key:"s" }
]);
let buzzer = loadJSON(STORE_KEYS.buzzer, { first:null, open:true });

let currentTileRef = null; // {cIndex, tIndex}
let timer = { total:30, left:30, id:null, running:false };

function formatTime(sec){
  sec = Math.max(0, Math.round(sec));
  const m = Math.floor(sec/60), s = sec%60;
  return (m<10?"0":"")+m+":"+(s<10?"0":"")+s;
}

/* ====================== UI Elements ====================== */
const categoryRow = document.getElementById('categoryRow');
const grid = document.getElementById('grid');
const timeEl = document.getElementById('time');
const timerSet = document.getElementById('timerSet');
const startBtn = document.getElementById('startTimer');
const pauseBtn = document.getElementById('pauseTimer');
const resetBtn = document.getElementById('resetTimer');

const modal = document.getElementById('modal');
const modalQuestion = document.getElementById('modalQuestion');
const modalAnswer = document.getElementById('modalAnswer');
const modalMeta = document.getElementById('modalMeta');
const modalTime = document.getElementById('modalTime');
const modalBuzz = document.getElementById('modalBuzz');
const modalRevealBtn = document.getElementById('modalReveal');
const modalAwardBtn = document.getElementById('modalAward');
const modalCloseBtn = document.getElementById('modalClose');

const revealAnswerBtn = document.getElementById('revealAnswer');
const hideAnswerBtn = document.getElementById('hideAnswer');
const closeQuestionBtn = document.getElementById('closeQuestion');
const lockTileBtn = document.getElementById('lockTile');

const teamsEl = document.getElementById('teams');
const addTeamBtn = document.getElementById('addTeam');
const resetScoresBtn = document.getElementById('resetScores');

const firstBuzzEl = document.getElementById('firstBuzz');
const buzzerBar = document.getElementById('buzzerBar');
const resetBuzzersBtn = document.getElementById('resetBuzzers');

const toggleControlsBtn = document.getElementById('toggleControls');
const controlsPanel = document.getElementById('controls');
const fullscreenBtn = document.getElementById('fullscreenBtn');

const exportBtn = document.getElementById('exportBtn');
const importFile = document.getElementById('importFile');
const clearProgressBtn = document.getElementById('clearProgress');

const editCategory = document.getElementById('editCategory');
const editPoints   = document.getElementById('editPoints');
const editQuestion = document.getElementById('editQuestion');
const editAnswer   = document.getElementById('editAnswer');
const saveEditBtn  = document.getElementById('saveEdit');
const cancelEditBtn= document.getElementById('cancelEdit');

/* ====================== Board Rendering ====================== */
function renderBoard(){
  // Categories:
  categoryRow.innerHTML = "";
  gameSet.categories.forEach(c=>{
    const d = document.createElement('div');
    d.className = 'cat';
    d.textContent = c.name;
    categoryRow.appendChild(d);
  });
  // Tiles:
  grid.innerHTML = "";
  // Compute max tiles per category to build consistent rows
  const maxTiles = Math.max(...gameSet.categories.map(c=>c.tiles.length));
  for(let row=0; row<maxTiles; row++){
    gameSet.categories.forEach((cat, cIndex)=>{
      const tileData = cat.tiles[row];
      const tile = document.createElement('button');
      tile.className = 'tile';
      tile.setAttribute('aria-label', 'Question tile');
      if(!tileData){
        tile.classList.add('locked');
        tile.textContent = "—";
        tile.disabled = true;
      } else {
        tile.textContent = tileData.points;
        const key = `${cIndex}:${row}`;
        if(progress.used[key]) tile.classList.add('used');
        if(progress.locked[key]) tile.classList.add('locked');
        tile.addEventListener('click', ()=>openQuestion(cIndex, row));
      }
      grid.appendChild(tile);
    });
  }
}
function tileKey(ref){ return `${ref.cIndex}:${ref.tIndex}`; }

/* ====================== Modal & Question Flow ====================== */
function openQuestion(cIndex, tIndex){
  const data = gameSet.categories[cIndex].tiles[tIndex];
  currentTileRef = {cIndex, tIndex};
  modal.classList.add('open');
  modalQuestion.textContent = data.q;
  modalAnswer.textContent = data.a;
  modalAnswer.classList.remove('show');
  modalMeta.textContent = `${gameSet.categories[cIndex].name} • ${data.points} pts`;
  modalBuzz.textContent = buzzer.first ? teamById(buzzer.first).name : "—";
  setTimerFromControl();
  pauseTimer(); // start paused; host chooses
  sound('whoosh');
}
function closeModal(){
  modal.classList.remove('open');
  currentTileRef = null;
}
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

/* ====================== Timer ====================== */
function setTimerFromControl(){
  const t = parseInt(timerSet.value||"30",10);
  timer.total = Math.max(3, Math.min(120, t));
  timer.left = timer.total;
  updateTimerUI();
}
function updateTimerUI(){
  timeEl.textContent = formatTime(timer.left);
  modalTime.textContent = formatTime(timer.left);
}
function tick(){
  timer.left -= 1;
  updateTimerUI();
  if(timer.left<=0){ pauseTimer(); sound('buzz'); }
}
function startTimer(){
  if(timer.running) return;
  timer.running = true;
  timer.id = setInterval(tick, 1000);
}
function pauseTimer(){
  timer.running = false;
  if(timer.id){ clearInterval(timer.id); timer.id = null; }
}
function resetTimer(){
  timer.left = timer.total;
  updateTimerUI();
}

startBtn.onclick = startTimer;
pauseBtn.onclick = pauseTimer;
resetBtn.onclick = resetTimer;
timerSet.onchange = ()=>{ setTimerFromControl(); sound('click'); };

/* ====================== Teams & Scores ====================== */
function teamById(id){ return teams.find(t=>t.id===id); }

function renderTeams(){
  teamsEl.innerHTML = "";
  teams.forEach((t, idx)=>{
    const row = document.createElement('div'); row.className='team';
    const name = document.createElement('input'); name.value = t.name; name.className='name';
    name.onchange = ()=>{ t.name = name.value.trim()||`Team ${idx+1}`; saveJSON(STORE_KEYS.teams, teams); renderBuzzers(); };

    const sc = document.createElement('div'); sc.className='score'; sc.textContent = t.score;

    const tools = document.createElement('div'); tools.className='bar';
    const plus = document.createElement('button'); plus.className='btn ok'; plus.textContent='+';
    const minus = document.createElement('button'); minus.className='btn danger'; minus.textContent='–';
    const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Remove';
    const keyBtn = document.createElement('button'); keyBtn.className='btn secondary'; keyBtn.title="Change buzzer key";
    keyBtn.textContent = `Key: ${t.key.toUpperCase()}`;
    keyBtn.onclick = ()=>{
      keyBtn.textContent = "Press a key…";
      const onKey = (e)=>{
        e.preventDefault();
        t.key = e.key.toLowerCase();
        keyBtn.textContent = `Key: ${t.key.toUpperCase()}`;
        saveJSON(STORE_KEYS.teams, teams); renderBuzzers();
        window.removeEventListener('keydown', onKey, true);
      };
      window.addEventListener('keydown', onKey, true);
    };

    plus.onclick = ()=> adjustScore(t.id, currentTileRef ? gameSet.categories[currentTileRef.cIndex].tiles[currentTileRef.tIndex].points : 100);
    minus.onclick= ()=> adjustScore(t.id, -(currentTileRef ? gameSet.categories[currentTileRef.cIndex].tiles[currentTileRef.tIndex].points : 100));
    del.onclick  = ()=>{ teams = teams.filter(x=>x.id!==t.id); saveJSON(STORE_KEYS.teams, teams); renderTeams(); renderBuzzers(); };

    tools.append(plus, minus, keyBtn, del);
    row.append(name, sc, tools);
    teamsEl.appendChild(row);
  });
}
function adjustScore(id, delta){
  const t = teamById(id); if(!t) return;
  t.score += delta;
  saveJSON(STORE_KEYS.teams, teams);
  renderTeams();
  sound(delta>=0 ? 'ding' : 'buzz');
}
addTeamBtn.onclick = ()=>{
  teams.push({ id: crypto.randomUUID(), name:`Team ${teams.length+1}`, score:0, key: teams.length===2 ? 'k' : teams.length===3 ? 'l' : 'a' });
  saveJSON(STORE_KEYS.teams, teams);
  renderTeams(); renderBuzzers();
};
resetScoresBtn.onclick = ()=>{
  teams.forEach(t=>t.score=0);
  saveJSON(STORE_KEYS.teams, teams);
  renderTeams();
};

/* ====================== Buzzers ====================== */
function renderBuzzers(){
  buzzerBar.innerHTML = "";
  teams.forEach(t=>{
    const b = document.createElement('button');
    b.className = 'buzzer';
    b.innerHTML = `<div style="font-size:14px;opacity:.8">${t.name}</div><div style="font-size:22px; font-weight:900; margin-top:4px">BUZZ</div><div class="mini" style="margin-top:6px">Key: <span class="kbd">${t.key.toUpperCase()}</span></div>`;
    b.onclick = ()=> handleBuzz(t.id);
    buzzerBar.appendChild(b);
  });
  updateBuzzUI();
}
function updateBuzzUI(){
  firstBuzzEl.textContent = buzzer.first ? teamById(buzzer.first)?.name || "—" : "—";
  saveJSON(STORE_KEYS.buzzer, buzzer);
}
function handleBuzz(teamId){
  if(!buzzer.open) return;
  if(!buzzer.first){
    buzzer.first = teamId; buzzer.open=false;
    updateBuzzUI(); sound('buzz');
    modalBuzz.textContent = teamById(teamId).name;
  }
}
resetBuzzersBtn.onclick = ()=>{
  buzzer.first = null; buzzer.open = true;
  updateBuzzUI(); sound('click');
};

window.addEventListener('keydown', (e)=>{
  const k = e.key.toLowerCase();
  const t = teams.find(x=>x.key===k);
  if(t){ e.preventDefault(); handleBuzz(t.id); }
});

/* ====================== Sounds ====================== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function tone(freq=440, dur=0.12, type='sine', gain=0.04){
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = gain;
  o.connect(g).connect(audioCtx.destination);
  o.start();
  setTimeout(()=>{ o.stop(); }, dur*1000);
}
function sound(name){
  if(name==='ding'){ tone(880,.12,'triangle',.06); setTimeout(()=>tone(1320,.08,'triangle',.05),90); }
  if(name==='buzz'){ tone(140,.18,'sawtooth',.07); setTimeout(()=>tone(110,.18,'sawtooth',.06),110); }
  if(name==='click'){ tone(660,.05,'square',.025); }
  if(name==='whoosh'){ tone(600,.07,'sine',.02); setTimeout(()=>tone(400,.07,'sine',.02),70); }
}

/* ====================== Controls & Actions ====================== */
revealAnswerBtn.onclick = ()=>{ modalAnswer.classList.add('show'); sound('click'); };
hideAnswerBtn.onclick   = ()=>{ modalAnswer.classList.remove('show'); sound('click'); };
document.getElementById('modalReveal').onclick = ()=>{ modalAnswer.classList.add('show'); sound('click'); };

closeQuestionBtn.onclick = ()=> { markUsed(); closeModal(); renderBoard(); };
document.getElementById('modalClose').onclick  = ()=> { markUsed(); closeModal(); renderBoard(); };

lockTileBtn.onclick = ()=> {
  if(!currentTileRef) return;
  const key = tileKey(currentTileRef);
  progress.locked[key] = true;
  saveJSON(STORE_KEYS.progress, progress);
  renderBoard();
};

document.getElementById('toggleControls').onclick = ()=>{
  const hidden = controlsPanel.style.display==='none';
  controlsPanel.style.display = hidden ? '' : 'none';
  toggleControlsBtn.textContent = hidden ? 'Hide Controls' : 'Show Controls';
};

fullscreenBtn.onclick = ()=>{
  const el = document.getElementById('board');
  if(!document.fullscreenElement){ el.requestFullscreen?.(); }
  else{ document.exitFullscreen?.(); }
};

/* ====================== Awarding Points ====================== */
function markUsed(){
  if(!currentTileRef) return;
  progress.used[tileKey(currentTileRef)] = true;
  saveJSON(STORE_KEYS.progress, progress);
}
function awardTo(teamId){
  if(!currentTileRef) return;
  const pts = gameSet.categories[currentTileRef.cIndex].tiles[currentTileRef.tIndex].points;
  adjustScore(teamId, pts);
  markUsed();
  closeModal();
  renderBoard();
}
document.getElementById('modalAward').onclick = ()=>{
  if(!currentTileRef) return;
  const list = teams.map(t=>`${t.name} (+${gameSet.categories[currentTileRef.cIndex].tiles[currentTileRef.tIndex].points})`);
  const choice = prompt("Award points to which team?\n\n" + teams.map((t,i)=>`${i+1}. ${t.name}`).join("\n"));
  const idx = parseInt(choice||"",10)-1;
  if(!Number.isNaN(idx) && teams[idx]) awardTo(teams[idx].id);
};

/* ====================== Quick Edit (current question) ====================== */
function populateEditor(){
  if(!currentTileRef){ editCategory.value=""; editPoints.value=""; editQuestion.value=""; editAnswer.value=""; return;}
  const tile = gameSet.categories[currentTileRef.cIndex].tiles[currentTileRef.tIndex];
  editCategory.value = gameSet.categories[currentTileRef.cIndex].name;
  editPoints.value = tile.points;
  editQuestion.value = tile.q;
  editAnswer.value = tile.a;
}
saveEditBtn.onclick = ()=>{
  if(!currentTileRef) return;
  const cName = editCategory.value.trim();
  const pts   = parseInt(editPoints.value||"0",10);
  const q     = editQuestion.value.trim();
  const a     = editAnswer.value.trim();
  // apply:
  if(cName && cName !== gameSet.categories[currentTileRef.cIndex].name){
    gameSet.categories[currentTileRef.cIndex].name = cName;
  }
  const tile = gameSet.categories[currentTileRef.cIndex].tiles[currentTileRef.tIndex];
  tile.points = Number.isFinite(pts) ? pts : tile.points;
  if(q) tile.q = q;
  if(a) tile.a = a;
  saveJSON(STORE_KEYS.set, gameSet);
  renderBoard();
  sound('ding');
};
cancelEditBtn.onclick = ()=> populateEditor();

/* Sync editor when opening/closing */
document.getElementById('modal').addEventListener('transitionend', populateEditor);

/* ====================== Import / Export / Clear ====================== */
exportBtn.onclick = ()=>{
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(gameSet, null, 2));
  const a = document.createElement('a');
  a.href = dataStr; a.download = (gameSet.gameTitle?.toLowerCase().replace(/\s+/g,'-')||"quiz-set") + ".json";
  document.body.appendChild(a); a.click(); a.remove();
};
importFile.onchange = (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  const fr = new FileReader();
  fr.onload = ()=>{
    try{
      const obj = JSON.parse(fr.result);
      if(!obj.categories || !Array.isArray(obj.categories)) throw new Error("Invalid file");
      gameSet = obj; saveJSON(STORE_KEYS.set, gameSet);
      progress = { used:{}, locked:{} }; saveJSON(STORE_KEYS.progress, progress);
      renderBoard(); sound('ding');
    }catch(err){ alert("Import failed: " + err.message); }
    importFile.value = "";
  };
  fr.readAsText(file);
};
clearProgressBtn.onclick = ()=>{
  if(confirm("Clear all scores and question progress?")){
    teams.forEach(t=>t.score=0);
    saveJSON(STORE_KEYS.teams, teams);
    progress = { used:{}, locked:{} };
    saveJSON(STORE_KEYS.progress, progress);
    renderTeams(); renderBoard(); sound('buzz');
  }
};

/* ====================== Hook up cross-UI buttons ====================== */
document.getElementById('revealAnswer').onclick = ()=>{ modalAnswer.classList.add('show'); sound('click'); };
document.getElementById('hideAnswer').onclick   = ()=>{ modalAnswer.classList.remove('show'); sound('click'); };
document.getElementById('closeQuestion').onclick= ()=>{ markUsed(); closeModal(); renderBoard(); };

/* ====================== Init ====================== */
function init(){
  // Fill default timer
  timer.left = timer.total = Math.max(3, Math.min(120, parseInt(timerSet.value||"30",10)));
  updateTimerUI();
  renderBoard();
  renderTeams();
  renderBuzzers();
}
init();
</script>
</body>
</html>
